name: Deploy

on:
  push:
    branches: [release]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://beacon:${{ secrets.DB_PASSWORD }}@localhost:5432/harmonic_beacon?schema=public
        run: npx prisma migrate deploy

      - name: Seed database
        env:
          DATABASE_URL: postgresql://beacon:${{ secrets.DB_PASSWORD }}@localhost:5432/harmonic_beacon?schema=public
        run: npx prisma db seed

      - name: Build Docker images
        run: |
          docker compose build --no-cache \
            --build-arg NEXT_PUBLIC_LIVEKIT_URL="${{ secrets.NEXT_PUBLIC_LIVEKIT_URL }}" \
            --build-arg NEXT_PUBLIC_GO2RTC_URL="${{ secrets.NEXT_PUBLIC_GO2RTC_URL }}"

      - name: Deploy services
        env:
          DATABASE_URL: postgresql://beacon:${{ secrets.DB_PASSWORD }}@host.docker.internal:5432/harmonic_beacon?schema=public
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          AUTH_ZITADEL_ID: ${{ secrets.AUTH_ZITADEL_ID }}
          AUTH_ZITADEL_ISSUER: ${{ secrets.AUTH_ZITADEL_ISSUER }}
          LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
          PUBLIC_IP: ${{ secrets.PUBLIC_IP }}
        run: |
          # Stop old standalone container if it exists
          docker stop harmonic-beacon 2>/dev/null || true
          docker rm harmonic-beacon 2>/dev/null || true

          # Deploy with compose (secrets passed via env vars, no .env file)
          docker compose up -d --remove-orphans

          # Wait for services to be healthy
          echo "Waiting for services to be healthy..."
          sleep 10

          # Verify app is responding
          curl -f http://localhost:3003 || exit 1

          # Verify go2rtc is responding
          curl -f http://127.0.0.1:1984/api || exit 1

          echo "Deployment successful"

      - name: Cleanup old images
        if: success()
        run: |
          docker image prune -f --filter "until=168h" 2>/dev/null || true

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, attempting rollback..."
          docker compose down 2>/dev/null || true
          # Try to restart with previous images
          docker compose up -d 2>/dev/null || true
